<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
<title>Twisted Documentation: Deferreds are beautiful! (A Tutorial)</title>
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
  </head>

  <body bgcolor="white">
    <h1 class="title">Deferreds are beautiful! (A Tutorial)</h1>
    <div class="toc"><ol><li><a href="#auto0">Introduction</a></li><li><a href="#auto1">A simple example</a></li><li><a href="#auto2">Errbacks</a></li><ul><li><a href="#auto3">Failure in requested operation</a></li><li><a href="#auto4">Exceptions raised in callbacks</a></li><li><a href="#auto5">Exceptions will only be handled by errbacks</a></li><li><a href="#auto6">Handling an exception and continuing on</a></li></ul><li><a href="#auto7">addBoth: the deferred version of finally</a></li><li><a href="#auto8">addCallbacks: decision making based on previous success or failure</a></li><li><a href="#auto9">Hints, tips, common mistakes, and miscellaney</a></li><ul><li><a href="#auto10">The deferred callback chain is stateful</a></li><li><a href="#auto11">Don't call .callback() on deferreds you didn't create!</a></li><li><a href="#auto12">Callbacks can return deferreds</a></li></ul><li><a href="#auto13">Conclusion</a></li></ol></div>
    <div class="content">
<span/>

<h2>Introduction<a name="auto0"/></h2>

<p>Deferreds are quite possibly the single most confusing topic that a
newcomer to Twisted has to deal with. I am going to forgo the normal talk
about what deferreds are, what they aren't, and why they're used in Twisted.
Instead, I'm going show you the logic behind what they <strong>do</strong>.</p>


<p>A deferred allows you to encapsulate the logic that you'd normally use to
make a series of function calls after receiving a result into a single object.
In the examples that follow, I'll first show you what's going to go on behind 
the scenes in the deferred chain, then show you the deferred API calls that set
up that chain. All of these examples are runnable code, so feel free to play 
around with them.</p>

 
<h2>A simple example<a name="auto1"/></h2>

First, a simple example so that we have something to talk about:

<div class="py-listing"><pre><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
Here we have the simplest case, a single callback and a single errback.
&quot;&quot;&quot;</span>

<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-keyword">global</span> <span class="py-src-variable">num</span>; <span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-comment"># equivalent to d.callback(result)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-keyword">global</span> <span class="py-src-variable">num</span>; <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex.py"><span class="filename">listings/deferred/deferred_ex.py</span></a></div></div>

<p>And the output: (since both methods in the example produce the same output,
it will only be shown once.) </p>

<pre xml:space="preserve">
callback 1
        got result: success
</pre>

<p>Here we have the simplest case. A deferred with a single callback and a
single errback. Normally, a function would create a deferred and hand it back
to you when you request an operation that needs to wait for an event for
completion.  The object you called then does <code>d.callback(result)</code>
when the results are in.  
</p>

<p>The thing to notice is that there is only one result that is passed from
method to method, and that the result returned from a method is the argument
to the next method in the chain. In case of an exception, result is set to an
instance of <code class="API"><a href="http://twistedmatrix.com/documents/11.0.0/api/twisted.python.failure.Failure.html" title="twisted.python.failure.Failure">Failure</a></code>
that describes the exception.</p>

<h2>Errbacks<a name="auto2"/></h2>
<h3>Failure in requested operation<a name="auto3"/></h3>
<p>Things don't always go as planned, and sometimes the function that
returned the deferred needs to alert the callback chain that an error
has occurred.</p>

<div class="py-listing"><pre><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
This example is analogous to a function calling .errback(failure)
&quot;&quot;&quot;</span>


<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">errback</span>(<span class="py-src-variable">result</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">result</span> = <span class="py-src-variable">None</span>
    <span class="py-src-keyword">try</span>:
        <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;*doh*! failure!&quot;</span>
    <span class="py-src-keyword">except</span>:
        <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-variable">result</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>(<span class="py-src-variable">result</span>)
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex1a.py"><span class="filename">listings/deferred/deferred_ex1a.py</span></a></div></div>

<pre xml:space="preserve">
errback
we got an exception: Traceback (most recent call last):
--- exception caught here ---
  File &quot;deferred_ex1a.py&quot;, line 73, in ?
    raise RuntimeError, &quot;*doh*! failure!&quot;
exceptions.RuntimeError: *doh*! failure!
</pre>

<p> The important thing to note (as it will come up again in later examples)
is that the callback isn't touched, the failure goes right to the errback.
Also note that the errback trap()s the expected exception type. If you don't
trap the exception, an error will be logged when the deferred is
garbage-collected. 
</p>


<h3>Exceptions raised in callbacks<a name="auto4"/></h3>

<p>Now let's see what happens when <em>our callback</em> raises an
exception</p>

<div class="py-listing"><pre><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
Here we have a slightly more involved case. The deferred is called back with a
result. the first callback returns a value, the second callback, however
raises an exception, which is handled by the errback.
&quot;&quot;&quot;</span>


<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failAtHandlingResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex1b.py"><span class="filename">listings/deferred/deferred_ex1b.py</span></a></div></div>

<p>And the output: (note, tracebacks will be edited slightly to conserve
space)</p>

<pre xml:space="preserve">
callback 1
        got result: success
callback 2
        got result: yay! handleResult was successful!
        about to raise exception
errback
we got an exception: Traceback (most recent call last):
--- &lt;exception caught here&gt; ---
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line
326, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File &quot;./deferred_ex1.py&quot;, line 32, in failAtHandlingResult
    raise RuntimeError, &quot;whoops! we encountered an error&quot;
exceptions.RuntimeError: whoops! we encountered an error
</pre>

<p>If your callback raises an exception, the next method to be called will be 
the next errback in your chain.</p>


<h3>Exceptions will only be handled by errbacks<a name="auto5"/></h3>

<p>If a callback raises an exception the next method to be called will be next
errback in the chain. If the chain is started off with a failure, the first
method to be called will be the first errback.</p>

<div class="py-listing"><pre><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
This example shows an important concept that many deferred newbies
(myself included) have trouble understanding.

when an error occurs in a callback, the first errback after the error
occurs will be the next method called. (in the next example we'll
see what happens in the 'chain' after an errback).
&quot;&quot;&quot;</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>



<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-comment"># equivalent to d.callback(result)</span>

    <span class="py-src-comment"># now, let's make the error happen in the first callback</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failAtHandlingResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-comment"># note: this callback will be skipped because</span>
    <span class="py-src-comment"># result is a failure</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()



<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex2.py"><span class="filename">listings/deferred/deferred_ex2.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: success
        about to raise exception
errback
we got an exception: Traceback (most recent call last):
  File &quot;./deferred_ex2.py&quot;, line 85, in ?
    nonDeferredExample(&quot;success&quot;)
--- &lt;exception caught here&gt; ---
  File &quot;./deferred_ex2.py&quot;, line 46, in nonDeferredExample
    result = failAtHandlingResult(result)
  File &quot;./deferred_ex2.py&quot;, line 35, in failAtHandlingResult
    raise RuntimeError, &quot;whoops! we encountered an error&quot;
exceptions.RuntimeError: whoops! we encountered an error
</pre>

<p>You can see that our second callback, handleResult was not called because
failAtHandlingResult raised an exception</p>

<h3>Handling an exception and continuing on<a name="auto6"/></h3>

<p>In this example, we see an errback handle an exception raised in the
preceeding callback.  Take note that it could just as easily been an exception
from <strong>any other</strong> preceeding method. You'll see that after the
exception is handled in the errback (i.e.  the errback does not return a
failure or raise an exception) the chain continues on with the next
callback.</p>

<div class="py-listing"><pre><p class="py-linenumber">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
Now we see how an errback can handle errors. if an errback
does not raise an exception, the next callback in the chain
will be called.
&quot;&quot;&quot;</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;okay, continue on&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">callbackAfterErrback</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)



<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-comment"># equivalent to d.callback(result)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failAtHandlingResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">callbackAfterErrback</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>



<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">callbackAfterErrback</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex3.py"><span class="filename">listings/deferred/deferred_ex3.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: success
callback 2
        got result: yay! handleResult was successful!
        about to raise exception
errback
we got an exception: Traceback (most recent call last):
  File &quot;./deferred_ex3.py&quot;, line 97, in &lt;module&gt;
    deferredExample()
  File &quot;./deferred_ex3.py&quot;, line 90, in deferredExample
    d.callback(&quot;success&quot;)
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line 243, in callback
    self._startRunCallbacks(result)
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line 312, in _startRunCallbacks
    self._runCallbacks()
--- &lt;exception caught here&gt; ---
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line 328, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File &quot;./deferred_ex3.py&quot;, line 34, in failAtHandlingResult
    raise RuntimeError, &quot;whoops! we encountered an error&quot;
exceptions.RuntimeError: whoops! we encountered an error

callback 3
        got result: okay, continue on
</pre>

<h2>addBoth: the deferred version of <em>finally</em><a name="auto7"/></h2>

<p>Now we see how deferreds do <strong>finally</strong>, with .addBoth. The
callback that gets added as addBoth will be called if the result is a failure
or non-failure. We'll also see in this example, that our doThisNoMatterWhat()
method follows a common idiom in deferred callbacks by acting as a passthru,
returning the value that it received to allow processing the chain to
continue, but appearing transparent in terms of the result.</p>

<div class="py-listing"><pre><p class="py-linenumber">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
Now we'll see what happens when you use 'addBoth'.
&quot;&quot;&quot;</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;okay, continue on&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">doThisNoMatterWhat</span>(<span class="py-src-parameter">arg</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;both %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot argument %r&quot;</span> % (<span class="py-src-variable">arg</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tdoing something very important&quot;</span>
    <span class="py-src-comment"># we pass the argument we received to the next phase here</span>
    <span class="py-src-keyword">return</span> <span class="py-src-variable">arg</span>



<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-comment"># equivalent to d.callback(result)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failAtHandlingResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-comment"># ---- this is equivalent to addBoth(doThisNoMatterWhat)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>):
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">doThisNoMatterWhat</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">doThisNoMatterWhat</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addBoth</span>(<span class="py-src-variable">doThisNoMatterWhat</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex4.py"><span class="filename">listings/deferred/deferred_ex4.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: success
callback 2
        got result: yay! handleResult was successful!
        about to raise exception
both 3
        got argument &lt;twisted.python.failure.Failure exceptions.RuntimeError&gt;
        doing something very important
errback
we got an exception: Traceback (most recent call last):
--- &lt;exception caught here&gt; ---
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line
326, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File &quot;./deferred_ex4.py&quot;, line 32, in failAtHandlingResult
    raise RuntimeError, &quot;whoops! we encountered an error&quot;
exceptions.RuntimeError: whoops! we encountered an error
</pre>

<p>You can see that the errback is called, (and consequently, the failure is
trapped).  This is because doThisNoMatterWhat method returned the value it
received, a failure.</p>

<h2>addCallbacks: decision making based on previous success or failure<a name="auto8"/></h2>

<p>As we've been seeing in the examples, the callback is a pair of
callback/errback.  Using addCallback or addErrback is actually a special case
where one of the pair is a pass statement. If you want to make a decision
based on whether or not the previous result in the chain was a failure or not
(which is very rare, but included here for completeness), you use
addCallbacks. Note that this is <strong>not</strong> the same thing as an
addCallback followed by an addErrback.</p>


<div class="py-listing"><pre><p class="py-linenumber">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
Now comes the more nuanced addCallbacks, which allows us to make a
yes/no (branching) decision based on whether the result at a given point is
a failure or not.
&quot;&quot;&quot;</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;okay, continue on&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">yesDecision</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;yes decision %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\twasn't a failure, so we can plow ahead&quot;</span>
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;go ahead!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">noDecision</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-variable">result</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;no decision %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\t*doh*! a failure! quick! damage control!&quot;</span>
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;damage control successful!&quot;</span>



<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failAtHandlingResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-comment"># this is equivalent to addCallbacks(yesDecision, noDecision)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">yesDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">noDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-comment"># this is equivalent to addCallbacks(yesDecision, noDecision)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">yesDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">noDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallbacks</span>(<span class="py-src-variable">yesDecision</span>, <span class="py-src-variable">noDecision</span>) <span class="py-src-comment"># noDecision will be called</span>
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>) <span class="py-src-comment"># - A -</span>
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallbacks</span>(<span class="py-src-variable">yesDecision</span>, <span class="py-src-variable">noDecision</span>) <span class="py-src-comment"># yesDecision will be called</span>
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex5.py"><span class="filename">listings/deferred/deferred_ex5.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: success
        about to raise exception
no decision 2
        *doh*! a failure! quick! damage control!
callback 3
        got result: damage control successful!
yes decision 4
        wasn't a failure, so we can plow ahead
callback 5
        got result: go ahead!
</pre>

<p>Notice that our errback is never called. The noDecision method returns a
non-failure so processing continues with the next callback. If we wanted to
skip the callback at &quot;- A -&quot; because of the error, but do some kind of
processing in response to the error, we would have used a passthru, and
returned the failure we received, as we see in this next example: </p>

<div class="py-listing"><pre><p class="py-linenumber">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
Now comes the more nuanced addCallbacks, which allows us to make a
yes/no (branching) decision based on whether the result at a given point is
a failure or not.

here, we return the failure from noDecisionPassthru, the errback argument to
the first addCallbacks method invocation, and see what happens.
&quot;&quot;&quot;</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;okay, continue on&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">yesDecision</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;yes decision %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\twasn't a failure, so we can plow ahead&quot;</span>
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;go ahead!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">noDecision</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-variable">result</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;no decision %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\t*doh*! a failure! quick! damage control!&quot;</span>
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;damage control successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">noDecisionPassthru</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;no decision %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\t*doh*! a failure! don't know what to do, returning failure!&quot;</span>
    <span class="py-src-keyword">return</span> <span class="py-src-variable">result</span>


<span class="py-src-keyword">def</span> <span class="py-src-identifier">behindTheScenes</span>(<span class="py-src-parameter">result</span>):

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failAtHandlingResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-comment"># this is equivalent to addCallbacks(yesDecision, noDecision)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">yesDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">noDecisionPassthru</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-comment"># this is equivalent to addCallbacks(yesDecision, noDecision)</span>

    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">yesDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">noDecision</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleResult</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">pass</span>


    <span class="py-src-keyword">if</span> <span class="py-src-keyword">not</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">result</span>, <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>): <span class="py-src-comment"># ---- callback</span>
        <span class="py-src-keyword">pass</span>
    <span class="py-src-keyword">else</span>:                                       <span class="py-src-comment"># ---- errback</span>
        <span class="py-src-keyword">try</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">handleFailure</span>(<span class="py-src-variable">result</span>)
        <span class="py-src-keyword">except</span>:
            <span class="py-src-variable">result</span> = <span class="py-src-variable">failure</span>.<span class="py-src-variable">Failure</span>()


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)

    <span class="py-src-comment"># noDecisionPassthru will be called</span>
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallbacks</span>(<span class="py-src-variable">yesDecision</span>, <span class="py-src-variable">noDecisionPassthru</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>) <span class="py-src-comment"># - A -</span>

    <span class="py-src-comment"># noDecision will be called</span>
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallbacks</span>(<span class="py-src-variable">yesDecision</span>, <span class="py-src-variable">noDecision</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>) <span class="py-src-comment"># - B -</span>
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">behindTheScenes</span>(<span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex6.py"><span class="filename">listings/deferred/deferred_ex6.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: success
        about to raise exception
no decision 2
        *doh*! a failure! don't know what to do, returning failure!
no decision 3
        *doh*! a failure! quick! damage control!
callback 4
        got result: damage control successful!
</pre>

<p>Two things to note here. First, &quot;- A -&quot; was skipped, like we wanted it to,
and the second thing is that after &quot;- A -&quot;, noDecision is called, because  <strong>it is the next errback that exists in the chain</strong>. It returns a
non-failure, so processing continues with the next callback at &quot;- B -&quot;, and
the errback at the end of the chain is never called </p>

<h2>Hints, tips, common mistakes, and miscellaney<a name="auto9"/></h2>

<h3>The deferred callback chain is stateful<a name="auto10"/></h3>

<p>A deferred that has been called back will call its addCallback and
addErrback methods as appropriate in the order they are added, when they are
added. So we see in the following example, deferredExample1 and
deferredExample2 are equivalent. The first sets up the processing chain
beforehand and then executes it, the other executes the chain as it is being
constructed.  This is because deferreds are <em>stateful</em>.  </p>

<div class="py-listing"><pre><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>

<span class="py-src-string">&quot;&quot;&quot;
The deferred callback chain is stateful, and can be executed before
or after all callbacks have been added to the chain
&quot;&quot;&quot;</span>

<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-variable">f</span>.<span class="py-src-variable">trap</span>(<span class="py-src-variable">RuntimeError</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">return</span> <span class="py-src-string">&quot;yay! handleResult was successful!&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">failAtHandlingResult</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tabout to raise exception&quot;</span>
    <span class="py-src-keyword">raise</span> <span class="py-src-variable">RuntimeError</span>, <span class="py-src-string">&quot;whoops! we encountered an error&quot;</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample1</span>():
    <span class="py-src-comment"># this is another common idiom, since all add* methods</span>
    <span class="py-src-comment"># return the deferred instance, you can just chain your</span>
    <span class="py-src-comment"># calls to addCallback and addErrback</span>

    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>
                       ).<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>
                       ).<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)

<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample2</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>()

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;success&quot;</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">failAtHandlingResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">handleResult</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">addErrback</span>(<span class="py-src-variable">handleFailure</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">deferredExample1</span>()
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\n-------------------------------------------------\n&quot;</span>
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">deferredExample2</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex7.py"><span class="filename">listings/deferred/deferred_ex7.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: success
        about to raise exception
errback
we got an exception: Traceback (most recent call last):
--- &lt;exception caught here&gt; ---
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line
326, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File &quot;./deferred_ex7.py&quot;, line 35, in failAtHandlingResult
    raise RuntimeError, &quot;whoops! we encountered an error&quot;
exceptions.RuntimeError: whoops! we encountered an error


-------------------------------------------------

callback 1
        got result: success
        about to raise exception
errback
we got an exception: Traceback (most recent call last):
--- &lt;exception caught here&gt; ---
  File &quot;/home/slyphon/Projects/Twisted/trunk/twisted/internet/defer.py&quot;, line
326, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File &quot;./deferred_ex7.py&quot;, line 35, in failAtHandlingResult
    raise RuntimeError, &quot;whoops! we encountered an error&quot;
exceptions.RuntimeError: whoops! we encountered an error
</pre>

<p>This example also shows you the common idiom of chaining calls to
addCallback and addErrback.
</p>

<h3>Don't call .callback() on deferreds you didn't create!<a name="auto11"/></h3>

<p>It is an error to reinvoke deferreds callback or errback method, therefore
if you didn't create a deferred, <strong>do not under any
circumstances</strong> call its callback or errback.  doing so will raise
an exception </p>

<h3>Callbacks can return deferreds<a name="auto12"/></h3>

<p>If you need to call a method that returns a deferred within your callback
chain, just return that deferred, and the result of the secondary deferred's
processing chain will become the result that gets passed to the next callback
of the primary deferreds processing chain </p>

<div class="py-listing"><pre><p class="py-linenumber"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</p><span class="py-src-comment">#!/usr/bin/env python</span>

<span class="py-src-comment"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="py-src-comment"># See LICENSE for details.</span>

<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">internet</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">defer</span>
<span class="py-src-keyword">from</span> <span class="py-src-variable">twisted</span>.<span class="py-src-variable">python</span> <span class="py-src-keyword">import</span> <span class="py-src-variable">failure</span>, <span class="py-src-variable">util</span>


<span class="py-src-keyword">class</span> <span class="py-src-identifier">Counter</span>(<span class="py-src-parameter">object</span>):
    <span class="py-src-variable">num</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">let</span> = <span class="py-src-string">'a'</span>

    <span class="py-src-keyword">def</span> <span class="py-src-identifier">incrLet</span>(<span class="py-src-parameter">cls</span>):
        <span class="py-src-variable">cls</span>.<span class="py-src-variable">let</span> = <span class="py-src-variable">chr</span>(<span class="py-src-variable">ord</span>(<span class="py-src-variable">cls</span>.<span class="py-src-variable">let</span>) + <span class="py-src-number">1</span>)
    <span class="py-src-variable">incrLet</span> = <span class="py-src-variable">classmethod</span>(<span class="py-src-variable">incrLet</span>)


<span class="py-src-keyword">def</span> <span class="py-src-identifier">handleFailure</span>(<span class="py-src-parameter">f</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;errback&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;we got an exception: %s&quot;</span> % (<span class="py-src-variable">f</span>.<span class="py-src-variable">getTraceback</span>(),)
    <span class="py-src-keyword">return</span> <span class="py-src-variable">f</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">subCb_B</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;sub-callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">let</span>,)
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">incrLet</span>()
    <span class="py-src-variable">s</span> = <span class="py-src-string">&quot; beautiful!&quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tadding %r to result&quot;</span> % (<span class="py-src-variable">s</span>,)
    <span class="py-src-variable">result</span> += <span class="py-src-variable">s</span>
    <span class="py-src-keyword">return</span> <span class="py-src-variable">result</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">subCb_A</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;sub-callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">let</span>,)
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">incrLet</span>()
    <span class="py-src-variable">s</span> = <span class="py-src-string">&quot; are &quot;</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tadding %r to result&quot;</span> % (<span class="py-src-variable">s</span>,)
    <span class="py-src-variable">result</span> += <span class="py-src-variable">s</span>
    <span class="py-src-keyword">return</span> <span class="py-src-variable">result</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">mainCb_1</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)
    <span class="py-src-variable">result</span> += <span class="py-src-string">&quot; Deferreds &quot;</span>

    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">subCb_A</span>
                       ).<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">subCb_B</span>)
    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-variable">result</span>)
    <span class="py-src-keyword">return</span> <span class="py-src-variable">d</span>

<span class="py-src-keyword">def</span> <span class="py-src-identifier">mainCb_2</span>(<span class="py-src-parameter">result</span>):
    <span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span> += <span class="py-src-number">1</span>
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;callback %s&quot;</span> % (<span class="py-src-variable">Counter</span>.<span class="py-src-variable">num</span>,)
    <span class="py-src-keyword">print</span> <span class="py-src-string">&quot;\tgot result: %s&quot;</span> % (<span class="py-src-variable">result</span>,)


<span class="py-src-keyword">def</span> <span class="py-src-identifier">deferredExample</span>():
    <span class="py-src-variable">d</span> = <span class="py-src-variable">defer</span>.<span class="py-src-variable">Deferred</span>().<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">mainCb_1</span>
                       ).<span class="py-src-variable">addCallback</span>(<span class="py-src-variable">mainCb_2</span>)

    <span class="py-src-variable">d</span>.<span class="py-src-variable">callback</span>(<span class="py-src-string">&quot;I hope you'll agree: &quot;</span>)


<span class="py-src-keyword">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">'__main__'</span>:
    <span class="py-src-variable">deferredExample</span>()
</pre><div class="caption">Source listing - <a href="listings/deferred/deferred_ex8.py"><span class="filename">listings/deferred/deferred_ex8.py</span></a></div></div>

<pre xml:space="preserve">
callback 1
        got result: I hope you'll agree: 
sub-callback a
        adding ' are ' to result
sub-callback b
        adding ' beautiful!' to result
callback 2
        got result: I hope you'll agree:  Deferreds  are  beautiful!
</pre>

<h2>Conclusion<a name="auto13"/></h2>

<p>Deferreds can be confusing, but only because they're so elegant and simple.
There is a lot of logical power that can expressed with a deferred's
processing chain, and once you see what's going on behind the curtain, it's a
lot easier to understand how to make use of what deferreds have to offer.</p>

</div>

    <p><a href="index.html">Index</a></p>
    <span class="version">Version: 11.0.0</span>
  </body>
</html>